<#body >
<div class="easyui-layout" fit="true">
    <!-- ====================================== ================================================================================ -->
    <!-- 上方布局 -->
    <!-- ====================================================================================================================== -->
    <div region="north" height="38" align="center">
        <div id="nav" style="padding-left:15px;padding-top:10px;" align="left">
            <#nav/>
        </div>
    </div>
    <div region="center" style="width:100%;padding-top: 1px" height="auto">
        <table class="easyui-datagrid" title="流程实例管理" id="processInstanceGrid" fitColumns="true" noheader="true" pageList="[50,100,200]"
               pagination="true" pageSize="50" pageNumber="1" pagePosition="top" rownumbers="false" remoteSort="false"
               loadMsg="数据加载中..." singleSelect="true" method="post" multiSort="false" sortName="id" url="${contextPath}/pi/listPage.action"
               align="center" striped="false" idField="id" data-options="border:true,onDblClickRow:showProgress" >
            <thead>
            <tr>
                <th data-options="field:'id',   sortable:true, order:'asc', align:'center', resizable:'true', fixed:'false'">
                    流程实例ID
                </th>
                <th data-options="field:'name',   sortable:true, order:'asc', align:'center', resizable:'true', fixed:'false'">
                    名称
                </th>
                <th  data-options="field:'deploymentId',   sortable:true, order:'asc', align:'center', resizable:'true', fixed:'false'">
                    部署ID
                </th>
                <th data-options="field:'processDefinitionId',   sortable:true, order:'asc', align:'center', resizable:'true', fixed:'false'">
                    流程定义ID
                </th>
                <th data-options="field:'processDefinitionVersion',   sortable:true, order:'asc', align:'center', resizable:'true', fixed:'false'">
                    版本号
                </th>
                <th  data-options="field:'processDefinitionName',   sortable:true, order:'asc', align:'center', resizable:'true', fixed:'false'">
                    流程定义名称
                </th>
                <th data-options="field:'processDefinitionKey',   sortable:true, order:'asc', align:'center', resizable:'true', fixed:'false'">
                    流程定义Key
                </th>
                <th data-options="field:'businessKey',  sortable:true, order:'asc', align:'center', resizable:'true', fixed:'false'">
                    BusinessKey
                </th>
                <th width="18%" data-options="field:'description',   sortable:true, order:'asc', align:'center', resizable:'true', fixed:'false'">
                    描述
                </th>

            </tr>
            </thead>
        </table>
        <!-- 隐藏编辑框 -->
        <div id="dlg" class="easyui-dialog" resizable="false" constrain="true" shadow="true" draggable="true" title="流程图" style="padding:20px" modal="true" border="thin" closed="true"
             data-options="
				iconCls: 'icon-save',
				width:1366,
				height: 640
			">
            <img id="processInstanceImg" />
        </div>
    </div>
</div>

<script>
    /**
     * 申领并完成任务
     */
    function claimAndCompleteTask() {
        var selected = $("#processInstanceGrid").datagrid("getSelected");
        if (null == selected) {
            swal('警告','请选中一条数据', 'warning');
            return;
        }
        var taskParam = $("#taskParam").val();
        var url = "${contextPath}/task/claimAndCompleteByPi.action?processInstanceId="+selected.id+"&"+taskParam;
        $.ajax({
            type: "POST",
            url: url,
            processData:true,
            dataType: "json",
            async : true,
            success: function (data) {
                if(data.success){
                    window.location.reload(false);
                }else{
                    swal('错误',data.result, 'error');
                }
            },
            error: function(){
                swal('错误', '远程访问失败', 'error');
            }
        });
    }
    /**
     * 查看进度图片
     * @param processInstanceId
     * @param processDefinitionId
     * @param processInstanceName
     */
    function showProgress(){
        var selected = $("#processInstanceGrid").datagrid("getSelected");
        if (null == selected) {
            swal('警告','请选中一条数据', 'warning');
            return;
        }
        $('#dlg').dialog('open');
        $('#dlg').dialog('center');
        var href = '${contextPath}/pi/progress.action?processInstanceId='+selected.id+'&processDefinitionId='+selected.processDefinitionId+"&"+Math.random();;
        $("#processInstanceImg").attr("src", href);
        $('#dlg').dialog('setTitle', "["+selected.processDefinitionName+"]流程图");
    }

    /**
     * 结束流程
     */
    function end(){
        var selected = $("#processInstanceGrid").datagrid("getSelected");
        if (null == selected) {
            swal('警告','请选中一条数据', 'warning');
            return;
        }
        <#swalConfirm swalTitle="您确认结束流程吗？">
        window.location.href = '${contextPath}/pi/end.action?processInstanceId='+selected.id;
        </#swalConfirm>
    }
$(function() {
    var pager = $("#processInstanceGrid").datagrid('getPager');
    pager.pagination({
        <#controls_paginationOpts/>,
        buttons:[
            {
                iconCls:'icon-data',
                text:'查看进度',
                handler:showProgress
            },
            {
                iconCls:'icon-no',
                text:'强制结束',
                handler:end
            }
        ]
    });
    <%if(has(processInstances)){%>
    $("#processInstanceGrid").datagrid("loadData", ${processInstances});
    <%}%>
})
</script>
</#body>