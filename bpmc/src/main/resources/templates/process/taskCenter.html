<#body head_title="任务页面">
<style>
    .datagrid-row {
        height: 48px;
    }
    .tab-selected{
        font-size:18px;
        color:#007dc3;
        display:inline;
        text-decoration:none;
    }
    .tab-unselected{
        font-size:18px;
        display:inline;
        color:#8e8e8e;
        text-decoration:none;
    }
</style>
<div class="easyui-layout" fit="true" >
    <!-- ====================================== ================================================================================ -->
    <!-- 上方布局 -->
    <!-- ====================================================================================================================== -->
    <div region="north" style="border-bottom: 1px solid #ababab;" align="center">
        <!-- =========================================================表单========================================================= -->
        <div class="easyui-panel gradient-title" style="width:100%;padding-top:10px;padding-bottom: 10px;" align="left" >
            <a <%if(category=='inbox'){%>class="tab-selected"<%}else{%>class="tab-unselected"<%}%> <%if(inboxCount>0){%>href="${contextPath}/task/tasks.html?category=inbox"<%}%> style="margin-left: 40px;">待办任务[${inboxCount}]</a>
            <a <%if(category=='tasks'){%>class="tab-selected"<%}else{%>class="tab-unselected"<%}%> <%if(tasksCount>0){%>href="${contextPath}/task/tasks.html?category=tasks"<%}%> style="margin-left: 18px;">我的任务[${tasksCount}]</a>
            <a <%if(category=='queued'){%>class="tab-selected"<%}else{%>class="tab-unselected"<%}%> <%if(queuedCount>0){%>href="${contextPath}/task/tasks.html?category=queued"<%}%> style="margin-left: 18px;">队列[${queuedCount}]</a>
            <a <%if(category=='involved'){%>class="tab-selected"<%}else{%>class="tab-unselected"<%}%> <%if(involvedCount>0){%>href="${contextPath}/task/tasks.html?category=involved"<%}%> style="margin-left: 18px;">受邀[${involvedCount}]</a>
        </div>
    </div>
    <div region="west" style="width:260px;padding-top: 1px;" height="auto">
        <% if(has(task)){%>
        <ul class="easyui-datalist" title="流程列表" lines="true" noheader="true" valueField="id" textField="name" loadMsg="数据加载中..."
            style="width:260px;height:100%" data-options="textFormatter:fmt, onClickRow:showTask">
            <% for(task in tasks){%>
            <li value="${task.id}">${task.name}</li>
            <%}%>
        </ul>
        <%}%>
    </div>
    <div region="center" style="float:left;width:100%;padding-top: 1px;" height="auto">
        <% if(has(task)){%>
        <div style="margin: 20px;position: relative; overflow: hidden; height: 50px;">
            <div style="overflow: hidden; padding-left: 0px; padding-top: 0px; position: absolute; left: 0px; top: 0px; width: 49px; height: 50px;">
                <img style="vertical-align: middle;" src="${contextPath}/resources/images/task-50.png"/>&nbsp;&nbsp;
            </div>
            <div style="height: 27px; overflow: hidden; padding-left: 0px; padding-top: 0px; position: absolute; left: 61px; top: 0px; width: 845px;">
                <span style="vertical-align: top; color:#007dc3;font-size: 20px;font-family: 'Microsoft YaHei';font-weight: bold;">${task.name}</span>
            </div>
            <div style="height: 18px; overflow: hidden; padding-left: 0px; padding-top: 0px; position: absolute; left: 61px; top: 32px; width: 845px;">
                <div style="float: left;" title="${task.priority}">
                    <img style="vertical-align: middle;" src="${contextPath}/resources/images/priority-medium-16.png"/>
                    <span id="taskPriorityDesc" style="vertical-align: middle;">${task.priority}</span>&nbsp;
                </div>
                <div title="${task.createTime, 'yyyy-MM-dd HH:mm:ss'}">
                    <img style="vertical-align: middle;" src="${contextPath}/resources/images/time.png"/>
                    <span style="vertical-align: middle;">创建于<span id="taskTimeDesc">${task.createTime, 'yyyy-MM-dd HH:mm:ss'}</span></span>
                </div>
            </div>
        </div>
        <hr/>
        <div style="margin: 20px;position: relative; overflow: hidden; height: 50px;">
            <%if(task.assignee == null){%>
            <a href="#" onclick="claimTask();" class="easyui-linkbutton" data-options="">签收</a>
            <%}%>
            <span>${task.description}</span>
            <br>
            <span>任务属于流程:'${processDefinitionName}'</span>
        </div>
        <%}%>
    </div>
</div>

<script>

    /**
     * 处理时间描述
     */
    function handlePublishTimeDesc(post_modified){
        // 拿到当前时间戳和发布时的时间戳，然后得出时间戳差
        var curTime = new Date();
        var postTime = new Date(post_modified);
        var timeDiff = curTime.getTime() - postTime.getTime();

        // 单位换算
        var min = 60 * 1000;
        var hour = min * 60;
        var day = hour * 24;
        var week = day * 7;

        // 计算发布时间距离当前时间的周、天、时、分
        var exceedWeek = Math.floor(timeDiff/week);
        var exceedDay = Math.floor(timeDiff/day);
        var exceedHour = Math.floor(timeDiff/hour);
        var exceedMin = Math.floor(timeDiff/min);

        // 最后判断时间差到底是属于哪个区间，然后return
        if(exceedWeek > 0){
            return post_modified;
        }else{
            if(exceedDay < 7 && exceedDay > 0){
                return exceedDay + '天前';
            }else{
                if(exceedHour < 24 && exceedHour > 0){
                    return exceedHour + '小时前';
                }else{
                    return exceedMin + '分钟前';
                }
            }
        }
    }

    /**
     * 处理优先级描述
     */
    function handlePriority(priority) {
        if(priority<=30){
            return "低";
        }else if(priority >30 && priority <=70){
            return "中";
        }else{
            return "高";
        }
    }

    /**
     * 申领任务
     */
    function claimTask() {
        $.ajax({
            type: "POST",
            url: "${contextPath}/task/claim.action",
            data: {taskId:"${task.id}"},
            processData:true,
            dataType: "json",
            async : true,
            success: function (data) {
                if(data.success){
                    location.href="${contextPath}/task/tasks.html?category=${category}";
                }else{
                    swal('错误',data.message, 'error');
                }
            },
            error: function(){
                swal('错误', '远程访问失败', 'error');
            }
        });

    }
    /**
     * 显示任务详情
     */
    function showTask(rowIndex, rowData) {
        location.href="${contextPath}/task/tasks.html?taskId="+rowData.id+"&category=${category}";
    }
    /**
     * 任务列表格式化器
     */
    function fmt(value,row,index){
        //选中当前任务
        if(row.id=='${task.id}'){
            return "<img style=\"vertical-align: middle;\" src=\"${contextPath}/resources/images/task-22.png\"/>&nbsp;&nbsp;<B style=\"color: #007dc3;\">"+value+"</B>";
        }else{
            return "<img style=\"vertical-align: middle;\" src=\"${contextPath}/resources/images/task-22.png\"/>&nbsp;&nbsp;<B>"+value+"</B>";
        }
    }
    $(function() {
        $("#taskTimeDesc").html(handlePublishTimeDesc("${task.createTime, 'yyyy-MM-dd HH:mm:ss'}"));
        $("#taskPriorityDesc").html(handlePriority(${task.priority}));
    })
</script>
</#body>